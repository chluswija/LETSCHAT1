rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if the request is from the owner
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Check if user is a participant of a chat
    function isChatParticipant(chatData) {
      return isAuthenticated() && request.auth.uid in chatData.participants;
    }
    
    // Check if user is blocked by another user
    function isBlocked(targetUserId) {
      return exists(/databases/$(database)/documents/users/$(targetUserId)) &&
             request.auth.uid in get(/databases/$(database)/documents/users/$(targetUserId)).data.blockedUsers;
    }
    
    // Check if user is admin of a group
    function isGroupAdmin(chatData) {
      return isAuthenticated() && request.auth.uid in chatData.admins;
    }
    
    // Validate timestamp is not in the future
    function isValidTimestamp(timestamp) {
      return timestamp <= request.time;
    }
    
    // ============================================
    // USERS COLLECTION
    // ============================================
    match /users/{userId} {
      // Allow read for authenticated users (for user search, contact info)
      allow read: if isAuthenticated();
      
      // Allow create only for the user themselves
      allow create: if isOwner(userId) &&
        request.resource.data.keys().hasAll(['uid', 'displayName', 'photoURL']) &&
        request.resource.data.uid == userId;
      
      // Allow update only for the user themselves
      allow update: if isOwner(userId) &&
        // Cannot change uid
        request.resource.data.uid == resource.data.uid;
      
      // Allow delete only for the user themselves
      allow delete: if isOwner(userId);
      
      // User's private data subcollection
      match /private/{docId} {
        allow read, write: if isOwner(userId);
      }
      
      // User's contacts subcollection
      match /contacts/{contactId} {
        allow read, write: if isOwner(userId);
      }
    }
    
    // ============================================
    // CHATS COLLECTION
    // ============================================
    match /chats/{chatId} {
      // Allow read only for participants
      allow read: if isChatParticipant(resource.data);
      
      // Allow create if user is a participant
      allow create: if isAuthenticated() &&
        request.auth.uid in request.resource.data.participants &&
        request.resource.data.participants.size() >= 2;
      
      // Allow update for participants (for typing, lastMessage, etc.)
      allow update: if isChatParticipant(resource.data) &&
        // Participants cannot be modified except by admins in groups
        (request.resource.data.participants == resource.data.participants ||
         (resource.data.type == 'group' && isGroupAdmin(resource.data)));
      
      // Allow delete only for private chats or group admins
      allow delete: if isChatParticipant(resource.data) &&
        (resource.data.type == 'private' || isGroupAdmin(resource.data));
      
      // Messages subcollection
      match /messages/{messageId} {
        // Allow read for chat participants
        allow read: if isChatParticipant(get(/databases/$(database)/documents/chats/$(chatId)).data);
        
        // Allow create if user is a participant and is the sender
        allow create: if isAuthenticated() &&
          isChatParticipant(get(/databases/$(database)/documents/chats/$(chatId)).data) &&
          request.resource.data.senderId == request.auth.uid &&
          request.resource.data.chatId == chatId;
        
        // Allow update for status changes (delivered, seen) by participants
        // Or for reactions by any participant
        allow update: if isAuthenticated() &&
          isChatParticipant(get(/databases/$(database)/documents/chats/$(chatId)).data) &&
          (
            // Sender can update status
            (resource.data.senderId == request.auth.uid) ||
            // Others can update status to delivered/seen or add reactions
            (request.resource.data.status in ['delivered', 'seen']) ||
            (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['reactions', 'status', 'seenBy', 'deliveredTo']))
          );
        
        // Allow delete only by sender (delete for everyone)
        allow delete: if resource.data.senderId == request.auth.uid;
      }
    }
    
    // ============================================
    // CONVERSATIONS (Groups) COLLECTION
    // ============================================
    match /conversations/{conversationId} {
      // Allow read for participants
      allow read: if isAuthenticated() && request.auth.uid in resource.data.members;
      
      // Allow create for authenticated users
      allow create: if isAuthenticated() &&
        request.auth.uid in request.resource.data.members &&
        request.auth.uid in request.resource.data.admins;
      
      // Allow update based on role and settings
      allow update: if isAuthenticated() &&
        request.auth.uid in resource.data.members &&
        (
          // Admins can update anything
          request.auth.uid in resource.data.admins ||
          // Non-admins can only update certain fields
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['typing', 'lastMessage', 'lastMessageTime'])
        );
      
      // Allow delete only for group creator or if only member
      allow delete: if isAuthenticated() &&
        (resource.data.createdBy == request.auth.uid ||
         (resource.data.members.size() == 1 && request.auth.uid in resource.data.members));
      
      // Messages subcollection for conversations
      match /messages/{messageId} {
        allow read: if isAuthenticated() && 
          request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.members;
        
        allow create: if isAuthenticated() &&
          request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.members &&
          request.resource.data.senderId == request.auth.uid;
        
        allow update: if isAuthenticated() &&
          request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.members;
        
        allow delete: if resource.data.senderId == request.auth.uid ||
          request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.admins;
      }
    }
    
    // ============================================
    // STATUSES COLLECTION
    // ============================================
    match /statuses/{statusId} {
      // Allow read based on visibility settings
      allow read: if isAuthenticated() &&
        (
          // Owner can always read
          resource.data.ownerId == request.auth.uid ||
          // Check visibility setting
          resource.data.visibility == 'everyone' ||
          (resource.data.visibility == 'contacts' && 
           request.auth.uid in get(/databases/$(database)/documents/users/$(resource.data.ownerId)).data.contacts) ||
          (resource.data.visibility == 'selected' && request.auth.uid in resource.data.visibleTo)
        );
      
      // Allow create for authenticated users
      allow create: if isAuthenticated() &&
        request.resource.data.ownerId == request.auth.uid;
      
      // Allow update (for viewedBy) by viewers, or full update by owner
      allow update: if isAuthenticated() &&
        (
          resource.data.ownerId == request.auth.uid ||
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['viewedBy'])
        );
      
      // Allow delete only by owner
      allow delete: if resource.data.ownerId == request.auth.uid;
    }
    
    // ============================================
    // CALLS COLLECTION
    // ============================================
    match /calls/{callId} {
      // Allow read for participants
      allow read: if isAuthenticated() && request.auth.uid in resource.data.participants;
      
      // Allow create for authenticated users
      allow create: if isAuthenticated() &&
        request.resource.data.callerId == request.auth.uid &&
        request.auth.uid in request.resource.data.participants;
      
      // Allow update for participants (to update status)
      allow update: if isAuthenticated() && request.auth.uid in resource.data.participants;
      
      // Allow delete for caller
      allow delete: if resource.data.callerId == request.auth.uid;
    }
    
    // ============================================
    // REPORTS COLLECTION (Admin only read)
    // ============================================
    match /reports/{reportId} {
      // Allow create for authenticated users
      allow create: if isAuthenticated() &&
        request.resource.data.reporterId == request.auth.uid;
      
      // No direct read/update/delete - handled by Cloud Functions
      allow read, update, delete: if false;
    }
    
    // ============================================
    // NOTIFICATIONS COLLECTION
    // ============================================
    match /notifications/{notificationId} {
      // Allow read only for the notification recipient
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // Allow update (mark as read) only for recipient
      allow update: if isAuthenticated() &&
        resource.data.userId == request.auth.uid &&
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read']);
      
      // No direct create - handled by Cloud Functions
      allow create: if false;
      
      // Allow delete for recipient
      allow delete: if resource.data.userId == request.auth.uid;
    }
    
    // ============================================
    // STARRED MESSAGES COLLECTION
    // ============================================
    match /starredMessages/{docId} {
      allow read, write: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
    }
    
    // ============================================
    // LABELS COLLECTION
    // ============================================
    match /labels/{labelId} {
      allow read, write: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
    }
  }
}
